import React, { useState, useEffect, useRef } from 'react';
import { Camera, Search, User, Briefcase, Smile, ChevronLeft, Plus, Users, Trash2, Timer, Award, Calendar } from 'lucide-react';

export default function RunnerCheckInApp() {
  // é é¢ç‹€æ…‹: 'home' (åˆ—è¡¨), 'add' (æ–°å¢), 'profile' (å€‹äººè©³æƒ…)
  const [view, setView] = useState('home');
  const [runners, setRunners] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedRunner, setSelectedRunner] = useState(null);
  const [showTodayOnly, setShowTodayOnly] = useState(true); // é è¨­åªçœ‹ä»Šå¤©
  
  // ä½¿ç”¨ useRef ä¾†è™•ç†è¡¨å–®è¼¸å…¥ (å¾¹åº•è§£æ±ºé‡æ–°æ¸²æŸ“å°è‡´è³‡æ–™æ¸…ç©ºçš„å•é¡Œ)
  const nameRef = useRef(null);
  const jobRef = useRef(null);
  const featureRef = useRef(null);
  const yearsRef = useRef(null);
  const paceRef = useRef(null); // æ”¹ç”¨ Ref ä¾†å„²å­˜é…é€Ÿé¸æ“‡
  
  // åªæœ‰ç…§ç‰‡é è¦½éœ€è¦ Stateï¼Œå› ç‚ºå®ƒéœ€è¦å³æ™‚æ›´æ–°ç•«é¢é¡¯ç¤ºåœ–ç‰‡
  const [photoPreview, setPhotoPreview] = useState(null);

  // é…é€Ÿé¸é …
  const paceOptions = [
    { label: 'ğŸš€ 3åˆ†é€Ÿ (èè‹±çµ„)', value: '3åˆ†é€Ÿ' },
    { label: 'ğŸ”¥ 4åˆ†é€Ÿ (æŒ‘æˆ°çµ„)', value: '4åˆ†é€Ÿ' },
    { label: 'ğŸƒ 5åˆ†é€Ÿ (å¸¸æ…‹çµ„)', value: '5åˆ†é€Ÿ' },
    { label: 'ğŸ’¦ 6åˆ†é€Ÿ (æ…¢è·‘çµ„)', value: '6åˆ†é€Ÿ' },
    { label: 'ğŸ¢ 7åˆ†é€Ÿ (é¤Šç”Ÿçµ„)', value: '7åˆ†é€Ÿ' },
    { label: 'ğŸ— æ­¡æ¨‚åƒå–çµ„', value: 'æ­¡æ¨‚åƒå–çµ„' },
  ];

  // è®€å– LocalStorage è³‡æ–™
  useEffect(() => {
    const savedRunners = localStorage.getItem('runnerData');
    if (savedRunners) {
      setRunners(JSON.parse(savedRunners));
    }
  }, []);

  // å„²å­˜è³‡æ–™åˆ° LocalStorage
  const saveToStorage = (data) => {
    localStorage.setItem('runnerData', JSON.stringify(data));
  };

  // è™•ç†ç…§ç‰‡ä¸Šå‚³
  const handleImageChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setPhotoPreview(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  // æäº¤æ–°è·‘è€…
  const handleSubmit = (e) => {
    e.preventDefault();
    
    // å¾ ref ç²å–ç•¶å‰å€¼
    const nameVal = nameRef.current.value;
    // è™•ç†ç©ºå€¼è½‰æ›ç‚º 0 æˆ–ä¿æŒåŸæœ¬è¼¸å…¥ï¼Œé€™è£¡ç°¡å–®è™•ç†è½‰æ› float
    const yearsVal = yearsRef.current.value ? parseFloat(yearsRef.current.value) : 0;
    const paceVal = paceRef.current.value; // å¾ Ref è®€å–é…é€Ÿ
    
    if (!nameVal || !photoPreview) {
      alert("è«‹å¡«å¯«åå­—ä¸¦æ‹ä¸€å¼µç…§ç‰‡ï¼");
      return;
    }

    if (yearsVal < 0) {
      alert("è·‘é½¡ä¸èƒ½æ˜¯è² æ•¸å–”ï¼æ™‚é–“æ˜¯ä¸èƒ½å€’æµçš„ XD");
      return;
    }

    const runnerEntry = {
      id: Date.now(),
      name: nameRef.current.value,
      job: jobRef.current.value,
      feature: featureRef.current.value,
      years: yearsRef.current.value,
      pace: paceVal,
      photo: photoPreview,
      date: new Date().toLocaleDateString('zh-TW'), // è¨˜éŒ„æ—¥æœŸç”¨æ–¼ç¯©é¸
      timestamp: Date.now()
    };

    const updatedRunners = [runnerEntry, ...runners];
    setRunners(updatedRunners);
    saveToStorage(updatedRunners);
    
    // é‡ç½®è¡¨å–®ä¸¦è¿”å›
    setPhotoPreview(null);
    // Ref çš„å€¼æœƒéš¨è‘—çµ„ä»¶å¸è¼‰(åˆ‡æ›view)è‡ªå‹•é‡ç½®ï¼Œä¸éœ€è¦æ‰‹å‹•æ¸…ç©º
    setView('home');
  };

  // åˆªé™¤è·‘è€…
  const handleDelete = (id, e) => {
    e.stopPropagation();
    if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ä½è·‘è€…çš„è³‡æ–™å—ï¼Ÿ")) {
      const updated = runners.filter(r => r.id !== id);
      setRunners(updated);
      saveToStorage(updated);
      if (selectedRunner?.id === id) setView('home');
    }
  };

  // å–å¾—ä»Šå¤©çš„æ—¥æœŸå­—ä¸²
  const todayStr = new Date().toLocaleDateString('zh-TW');

  // éæ¿¾æœå°‹ + æ—¥æœŸç¯©é¸
  const filteredRunners = runners.filter(r => {
    const matchesSearch = 
      r.name.includes(searchTerm) || 
      (r.job && r.job.includes(searchTerm)) || 
      (r.feature && r.feature.includes(searchTerm)) ||
      (r.pace && r.pace.includes(searchTerm));
      
    const matchesDate = showTodayOnly ? r.date === todayStr : true;
    
    return matchesSearch && matchesDate;
  });

  return (
    <div className="font-sans max-w-md mx-auto bg-zinc-900 h-screen overflow-hidden flex flex-col relative shadow-2xl shadow-black/50">
      
      {/* ä¸»è¦å…§å®¹å€ */}
      <div className="flex-1 overflow-y-auto scrollbar-hide">
        
        {/* === 1. é¦–é  View === */}
        {view === 'home' && (
          <div className="space-y-4 pb-24 bg-zinc-900 min-h-screen">
            {/* ä¿®æ”¹ï¼šç§»é™¤æ¼¸å±¤ï¼Œæ”¹ç‚ºç´”è‰² bg-lime-400 */}
            <header className="bg-lime-400 p-6 rounded-b-3xl shadow-lg text-black">
              <div className="flex justify-between items-start mb-4">
                <div className="flex items-center gap-3">
                  <img 
                    src="/public/data/image_5a1f5f.png" 
                    alt="NDL Logo" 
                    className="w-16 h-16 object-contain" 
                    onError={(e) => e.target.style.display = 'none'}
                  />
                  {/* ä¿®æ”¹ï¼šæ–‡å­—æ”¹ç‚º NERDINLOOP */}
                  <h1 className="text-2xl font-black tracking-wider">
                    NERDINLOOP <span className="text-sm block font-bold opacity-70">SIGN IN</span>
                  </h1>
                </div>
                <div className="text-xs bg-black/80 text-lime-400 px-3 py-1 rounded-full backdrop-blur-sm font-mono">
                  {todayStr}
                </div>
              </div>
              
              {/* ç°½åˆ°ç‰†åˆ‡æ›å™¨ */}
              <div className="flex p-1 bg-black/20 rounded-xl mt-4 mb-4">
                <button 
                  onClick={() => setShowTodayOnly(true)}
                  className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-1 ${showTodayOnly ? 'bg-black text-lime-400 shadow-sm font-bold' : 'text-black/60 hover:text-black'}`}
                >
                  <Calendar size={14} /> ä»Šæ—¥ç°½åˆ°
                </button>
                <button 
                  onClick={() => setShowTodayOnly(false)}
                  className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all flex items-center justify-center gap-1 ${!showTodayOnly ? 'bg-black text-lime-400 shadow-sm font-bold' : 'text-black/60 hover:text-black'}`}
                >
                  <Users size={14} /> æ‰€æœ‰æˆå“¡
                </button>
              </div>

              <div className="relative">
                <input
                  type="text"
                  placeholder="æœå°‹åå­—ã€è·æ¥­ã€é…é€Ÿ..."
                  className="w-full p-3 pl-10 rounded-xl text-zinc-200 placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-lime-400 shadow-inner bg-zinc-800/80 backdrop-blur-sm"
                  defaultValue={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
                <Search className="absolute left-3 top-3.5 text-zinc-500 w-5 h-5" />
              </div>
            </header>

            <div className="px-4">
              {runners.length === 0 ? (
                <div className="text-center py-20 text-zinc-500">
                  <div className="bg-zinc-800 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm border border-zinc-700">
                    <Camera className="w-10 h-10 text-zinc-600" />
                  </div>
                  <p className="text-lg font-medium text-zinc-400">é‚„æ²’æœ‰äººæ‰“å¡å–”ï¼</p>
                  <p className="text-sm">æˆç‚ºä»Šå¤©ç¬¬ä¸€å€‹æ‰“å¡çš„è·‘è€…å§</p>
                </div>
              ) : filteredRunners.length === 0 ? (
                <div className="text-center py-20 text-zinc-500">
                  <p className="text-lg text-zinc-400">
                    {showTodayOnly ? 'ä»Šå¤©é‚„æ²’äººæ‰“å¡ ğŸ˜´' : 'æ‰¾ä¸åˆ°ç¬¦åˆçš„è·‘è€…'}
                  </p>
                  {showTodayOnly && <p className="text-sm mt-2">åˆ‡æ›åˆ°ã€Œæ‰€æœ‰æˆå“¡ã€çœ‹çœ‹è€æœ‹å‹ï¼Ÿ</p>}
                </div>
              ) : (
                <div className="grid grid-cols-2 gap-4">
                  {filteredRunners.map(runner => (
                    <div 
                      key={runner.id}
                      onClick={() => { setSelectedRunner(runner); setView('profile'); }}
                      className="bg-zinc-800 rounded-2xl shadow-sm overflow-hidden hover:shadow-md transition-all cursor-pointer border border-zinc-700 group"
                    >
                      <div className="h-40 bg-zinc-700 relative overflow-hidden">
                        <img src={runner.photo} alt={runner.name} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                        <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent p-3 pt-8">
                          <span className="text-white font-bold truncate text-lg block">{runner.name}</span>
                        </div>
                        <div className="absolute top-2 right-2 bg-black/70 backdrop-blur-md px-2 py-1 rounded-md text-[10px] font-bold text-lime-400 shadow-sm border border-lime-400/30">
                          {runner.pace || 'æ­¡æ¨‚çµ„'}
                        </div>
                      </div>
                      <div className="p-3">
                        <div className="flex flex-wrap gap-1 mb-2">
                          <span className="text-[10px] bg-zinc-700 text-zinc-300 px-2 py-0.5 rounded-full flex items-center border border-zinc-600">
                              <Briefcase size={8} className="mr-1"/> {runner.job || 'æœªå¡«å¯«'}
                          </span>
                        </div>
                        <div className="text-xs text-lime-400 bg-zinc-900/50 px-2 py-1.5 rounded-lg line-clamp-1 border border-lime-400/20">
                          âœ¨ {runner.feature || 'æ„›è·‘æ­¥'}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* === 2. æ–°å¢ View === */}
        {view === 'add' && (
          <div className="p-4 h-full flex flex-col bg-zinc-900 text-white">
            <div className="flex items-center mb-6">
              <button onClick={() => setView('home')} className="p-2 bg-zinc-800 rounded-full mr-3 hover:bg-zinc-700 transition-colors">
                <ChevronLeft size={24} className="text-zinc-300" />
              </button>
              <h2 className="text-xl font-bold">æ‰“å¡ç°½åˆ°</h2>
            </div>

            <form onSubmit={handleSubmit} className="space-y-6 flex-1 overflow-y-auto pb-10">
              <div className="flex flex-col items-center justify-center">
                <label className="relative w-40 h-40 bg-zinc-800 rounded-full flex flex-col items-center justify-center border-2 border-dashed border-zinc-600 cursor-pointer overflow-hidden group hover:border-lime-400 transition-colors">
                  {photoPreview ? (
                    <img src={photoPreview} alt="Preview" className="w-full h-full object-cover" />
                  ) : (
                    <>
                      <Camera className="w-10 h-10 text-zinc-500 mb-2 group-hover:text-lime-400 transition-colors" />
                      <span className="text-xs text-zinc-400 font-medium group-hover:text-lime-400">é»æ“Šæ‹ç…§</span>
                    </>
                  )}
                  <input 
                    type="file" 
                    accept="image/*" 
                    capture="user" 
                    onChange={handleImageChange} 
                    className="hidden" 
                  />
                </label>
              </div>

              <div className="space-y-5">
                <div className="grid grid-cols-2 gap-4">
                  <div className="col-span-2">
                    <label className="block text-xs font-bold text-zinc-400 uppercase tracking-wide mb-1 ml-1">ç¨±å‘¼ (æš±ç¨±)</label>
                    <div className="relative">
                      <User className="absolute left-3 top-3.5 text-zinc-500 w-5 h-5" />
                      <input
                        ref={nameRef}
                        type="text"
                        required
                        defaultValue=""
                        className="w-full pl-10 p-3 bg-zinc-800 border border-zinc-700 rounded-xl focus:ring-2 focus:ring-lime-400 focus:outline-none transition-all text-white placeholder-zinc-500"
                        placeholder="ä¾‹å¦‚ï¼šå°æ˜"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-xs font-bold text-zinc-400 uppercase tracking-wide mb-1 ml-1">è·‘é½¡ (å¹´)</label>
                    <div className="relative">
                      <Award className="absolute left-3 top-3.5 text-zinc-500 w-5 h-5" />
                      <input
                        ref={yearsRef}
                        type="number"
                        step="0.1"
                        min="0"
                        defaultValue=""
                        className="w-full pl-10 p-3 bg-zinc-800 border border-zinc-700 rounded-xl focus:ring-2 focus:ring-lime-400 focus:outline-none transition-all text-white placeholder-zinc-500"
                        placeholder="å¦‚: 1.5"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-xs font-bold text-zinc-400 uppercase tracking-wide mb-1 ml-1">è·æ¥­</label>
                    <div className="relative">
                      <Briefcase className="absolute left-3 top-3.5 text-zinc-500 w-5 h-5" />
                      <input
                        ref={jobRef}
                        type="text"
                        defaultValue=""
                        className="w-full pl-10 p-3 bg-zinc-800 border border-zinc-700 rounded-xl focus:ring-2 focus:ring-lime-400 focus:outline-none transition-all text-white placeholder-zinc-500"
                        placeholder="å¦‚: å·¥ç¨‹å¸«"
                      />
                    </div>
                  </div>
                </div>

                <div>
                  <label className="block text-xs font-bold text-zinc-400 uppercase tracking-wide mb-1 ml-1">å¸¸æ…‹é…é€Ÿåˆ†çµ„</label>
                  <div className="relative">
                    <Timer className="absolute left-3 top-3.5 text-zinc-500 w-5 h-5 pointer-events-none" />
                    <select
                      ref={paceRef}
                      defaultValue="æ­¡æ¨‚åƒå–çµ„"
                      className="w-full pl-10 p-3 bg-zinc-800 border border-zinc-700 rounded-xl focus:ring-2 focus:ring-lime-400 focus:outline-none appearance-none text-white"
                    >
                      {paceOptions.map(opt => (
                        <option key={opt.value} value={opt.value} className="bg-zinc-800">{opt.label}</option>
                      ))}
                    </select>
                    <div className="absolute right-3 top-4 pointer-events-none text-zinc-500 text-xs">â–¼</div>
                  </div>
                </div>

                <div>
                  <label className="block text-xs font-bold text-zinc-400 uppercase tracking-wide mb-1 ml-1">
                    å¥½è¨˜ç‰¹å¾µ (é¸å¡«)
                  </label>
                  <div className="relative">
                    <Smile className="absolute left-3 top-3.5 text-zinc-500 w-5 h-5" />
                    <textarea
                      ref={featureRef}
                      rows="2"
                      className="w-full pl-10 p-3 bg-zinc-800 border border-zinc-700 rounded-xl focus:ring-2 focus:ring-lime-400 focus:outline-none transition-all resize-none text-white placeholder-zinc-500"
                      placeholder="ä¾‹å¦‚ï¼šç¸½æ˜¯ç©¿è¢å…‰è¥ªã€è·‘å®Œå¿…å–å¯æ¨‚"
                    />
                  </div>
                </div>
              </div>

              <button 
                type="submit" 
                className="w-full bg-lime-500 text-black p-4 rounded-xl font-bold text-lg shadow-lg shadow-lime-500/20 active:scale-95 transition-all mt-4 hover:bg-lime-400"
              >
                å®Œæˆç°½åˆ° âœ…
              </button>
            </form>
          </div>
        )}

        {/* === 3. è©³æƒ… View === */}
        {view === 'profile' && selectedRunner && (
          <div className="h-full bg-zinc-900 flex flex-col">
            <div className="relative h-2/5 group">
              <img src={selectedRunner.photo} alt={selectedRunner.name} className="w-full h-full object-cover" />
              <div className="absolute inset-0 bg-black/30 group-hover:bg-black/10 transition-colors" />
              <button 
                onClick={() => setView('home')} 
                className="absolute top-4 left-4 bg-black/50 p-2 rounded-full text-white backdrop-blur-sm hover:bg-black/70 transition-colors"
              >
                <ChevronLeft size={24} />
              </button>
              <button 
                onClick={(e) => handleDelete(selectedRunner.id, e)}
                className="absolute top-4 right-4 bg-red-500/80 p-2 rounded-full text-white backdrop-blur-sm hover:bg-red-600 transition-colors"
              >
                <Trash2 size={20} />
              </button>
            </div>
            
            <div className="flex-1 bg-zinc-900 -mt-8 rounded-t-3xl p-6 relative z-10 shadow-[0_-5px_25px_rgba(0,0,0,0.3)] overflow-y-auto border-t border-zinc-800">
              <div className="flex justify-between items-start mb-1">
                <h2 className="text-3xl font-bold text-white">{selectedRunner.name}</h2>
                <span className={`text-xs px-3 py-1 rounded-full font-medium border ${selectedRunner.date === todayStr ? 'bg-lime-500/20 text-lime-400 border-lime-500/30' : 'bg-zinc-800 text-zinc-400 border-zinc-700'}`}>
                  {selectedRunner.date === todayStr ? 'ğŸŸ¢ ä»Šæ—¥å·²ç°½åˆ°' : `ä¸Šæ¬¡: ${selectedRunner.date}`}
                </span>
              </div>
              <p className="text-lime-400 font-medium mb-6">{selectedRunner.pace || 'æœªåˆ†çµ„'} åˆ—è»Š</p>
              
              <div className="space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-zinc-800 p-4 rounded-2xl border border-zinc-700">
                      <div className="flex items-center gap-2 text-zinc-400 mb-1 text-xs font-bold uppercase">
                        <Briefcase size={14} /> è·æ¥­
                      </div>
                      <div className="font-bold text-white text-lg">
                        {selectedRunner.job || 'â€”'}
                      </div>
                  </div>
                  <div className="bg-zinc-800 p-4 rounded-2xl border border-zinc-700">
                      <div className="flex items-center gap-2 text-zinc-400 mb-1 text-xs font-bold uppercase">
                        <Award size={14} /> è·‘é½¡
                      </div>
                      <div className="font-bold text-white text-lg">
                        {selectedRunner.years ? `${selectedRunner.years} å¹´` : 'æ–°æ‰‹'}
                      </div>
                  </div>
                </div>

                <div className="bg-zinc-800/50 p-5 rounded-2xl border border-lime-500/30">
                  <div className="flex items-center gap-2 text-lime-400 mb-2 text-xs font-bold uppercase">
                      <Smile size={16} /> è¨˜æ†¶ç‰¹å¾µ
                  </div>
                  <p className="text-lg font-medium text-white leading-relaxed">
                    {selectedRunner.feature || 'é€™ä½è·‘è€…å¾ˆç¥ç§˜ï¼Œå¿«å»èªè­˜ä»–ï¼'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

      </div>

      {/* åº•éƒ¨å°èˆªæŒ‰éˆ• (åªåœ¨é¦–é é¡¯ç¤º) */}
      {view === 'home' && (
        <div className="absolute bottom-8 left-0 right-0 flex justify-center px-4 pointer-events-none">
          <button 
            onClick={() => setView('add')}
            className="pointer-events-auto bg-black text-lime-400 rounded-2xl px-8 py-4 shadow-xl shadow-lime-500/20 flex items-center gap-3 transform transition-all active:scale-95 hover:bg-zinc-900 hover:shadow-2xl border border-lime-500/30"
          >
            <Plus size={24} className="text-lime-400" />
            <div className="text-left">
              <span className="block font-bold text-lg leading-none">æˆ‘è¦ç°½åˆ°</span>
              <span className="text-[10px] text-lime-500 font-medium tracking-wider">CHECK IN</span>
            </div>
          </button>
        </div>
      )}
    </div>
  );
}